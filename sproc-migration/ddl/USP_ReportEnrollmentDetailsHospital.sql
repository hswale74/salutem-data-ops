 CREATE procedure [dbo].[USP_ReportEnrollmentDetailsHospital] ( 	@AccountID INT, 	@fromDate DATETIME, 	@toDate DATETIME, 	@status int, 	@ReportType varchar(50), 	@orderBy nvarchar(50) = 'PatientFullName',  	@orderDir varchar(4) = 'asc',  	@StartFrom int = 0,  	@PageSize int = 999999999 ) AS BEGIN  DECLARE @ToDateEnd DATETIME = @ToDate + 1;  --Creating temp table for storing employees enrollment activity outcome. --This is required because sometimes enrollment activity is getting completed in Enrollment as well as Discharge Info activities. --So here it might have multiple enrollment activities for the patient. We have to read the out come from last completed activity i.e. from discharge info activity. --In order to achive this result we are creating 3 temp tables. -- 1. #temp1 will have all the completed activity record for Enrollment and Discharg info activity. -- 2. #temp2 will have last completed activity record details for the each pateint. (max unique record for each pateint) -- 3. #EnrollmentActivityOutcome table will have latest record with Activity outcome name.  SELECT PA.Patient_ID, ILog.InPatientLogId, PA.Activity_ID, PA.ActivityOutcomeName,PA.SpentTimeInMinutes INTO #Temp1 FROM Trn_InPatientLog ILog  INNER JOIN  Trn_Patient_Activity PA ON  ILog.InPatientLogId = PA.InPatientLogId AND ILog.Patient_ID = PA.Patient_ID  INNER JOIN Mst_Activity A ON A.Activity_ID =  PA.Activity_ID AND A.ActivityType IN ('EnrollPatient','DischargeInfo') -- Reading only Enrollpatient and DischargeInfo completed activity WHERE PA.Activity_Start_Status > 2;  --Inserting max activity record in #temp table from #temp1 table. SELECT Patient_ID, InPatientLogId, MAX(Activity_ID) Activity_ID INTO #temp2  from #Temp1 GROUP BY Patient_ID, InPatientLogId ;  --Reading all record from #temp1 table with mapping #temp2. (It will get all the max activity record from table table) SELECT E.* INTO #EnrollmentActivityOutcome FROM #temp2 t INNER JOIN #Temp1 E ON t.Activity_ID=E.Activity_ID AND t.InPatientLogId=e.InPatientLogId AND t.Patient_ID=e.Patient_ID ;  With EnrollmentDetailsResult AS	(SELECT 									IPL.InPatientLogId, 									IPL.Patient_ID, 									IPL.EnrollmentDate, 									IPL.UnitNumber, 									patient.Patient_MRN, 									patient.Patient_First_Name +' '+ patient.Patient_Last_Name AS PatientFullName, 									patient.Patient_DOB, 									IPL.FinNumber, 									ME.Discription AS EnrollmentStatusName, 									E.ActivityOutcomeName AS EnrollmentOutcome, 									E.SpentTimeInMinutes, 									VFHW.Activity_Start_Date, 									VFHW.Discription AS ActvityStartStatusName, 									VFHW.Activity_Type_Name, 									VFHW.ActivityOutcomeName AS HomeVisitActivityOutcome, 									IPL.DischargeDate, 									patient.ZipCode, 									drg.DRGTitle 									FROM Trn_InPatientLog IPL 									INNER JOIN Mst_Enum ME ON IPL.EnrollmentStatus = ME.EnumValue AND ME.EnumType = 'EnrollmentStatus' 									INNER JOIN Mst_Patient patient ON patient.Patient_ID = IPL.Patient_ID AND patient.Account_ID = @AccountID 									LEFT JOIN #EnrollmentActivityOutcome E ON E.InPatientLogId = IPL.InPatientLogId 									LEFT JOIN View_HWF_PatientFirstHomeVisitStatus VFHW ON VFHW.Patient_ID = IPL.Patient_ID AND VFHW.InPatientLogId = IPL.InPatientLogId 									LEFT JOIN Mst_DRG drg  ON drg.ID = IPL.DRG 								WHERE IPL.EnrollmentDate >= @fromDate AND IPL.EnrollmentDate < @ToDateEnd 								AND (@status = 99 OR IPL.EnrollmentStatus = @status) 								AND IPL.EnrollmentDate IS NOT NULL 	  ), 	  OrderByResult AS (SELECT *, 			ROW_NUMBER() over ( 			order BY case when @orderBy = 'EnrollmentDate' and @orderDir = 'asc' then EnrollmentDate end, 								case when @orderBy = 'EnrollmentDate' and @orderDir = 'desc' then EnrollmentDate end desc, 								case when @orderBy = 'Patient_MRN' and @orderDir = 'asc' then Patient_MRN end, 								case when @orderBy = 'Patient_MRN' and @orderDir = 'desc' then Patient_MRN end desc, 								case when @orderBy = 'PatientFullName' and @orderDir = 'asc' then PatientFullName end, 								case when @orderBy = 'PatientFullName' and @orderDir = 'desc' then PatientFullName end desc, 								case when @orderBy = 'Patient_DOB' and @orderDir = 'asc' then PatientFullName end, 								case when @orderBy = 'Patient_DOB' and @orderDir = 'desc' then PatientFullName end desc, 								case when @orderBy = 'EnrollmentStatusName' and @orderDir = 'asc' then EnrollmentStatusName end, 								case when @orderBy = 'EnrollmentStatusName' and @orderDir = 'desc' then EnrollmentStatusName end desc, 								case when @orderBy = 'ActvityStartStatusName' and @orderDir = 'asc' then ActvityStartStatusName end, 								case when @orderBy = 'ActvityStartStatusName' and @orderDir = 'desc' then ActvityStartStatusName end desc 								 			) AS RowNumber FROM EnrollmentDetailsResult  	)   	SELECT *, (Select Count(Patient_ID) FROM EnrollmentDetailsResult) TotalRows   	FROM OrderByResult  	WHERE OrderByResult.RowNumber BETWEEN (@StartFrom + 1) AND (@StartFrom  + @pageSize)  	DROP TABLE #temp2 	DROP TABLE #Temp1 	DROP TABLE #EnrollmentActivityOutcome END  --EXEC USP_ReportEnrollmentDetailsHospital 21,'01Jan2021','30Jun2022',99,'','PatientID'