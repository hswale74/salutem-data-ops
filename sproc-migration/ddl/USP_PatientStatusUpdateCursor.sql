 CREATE procedure USP_PatientStatusUpdateCursor (@AccountID INT ) AS BEGIN 	DECLARE @Patient_ID int,@Patient_Activity_ID int, @TypeOfReferral int, @ActivityDate DateTime;  	DECLARE @InactivePatientStatusID int = (SELECT StatusID FROM MstPatientStatuses WHERE EnumStatusName = 'Inactive');  	DECLARE @IA_ActivityID int = (SELECT Activity_ID FROM Mst_Activity WHERE ActivityType = 'InitialAssessment'); 	DECLARE @PN_ActivityID int = (SELECT Activity_ID FROM Mst_Activity WHERE ActivityType = 'ProgressNote'); 	DECLARE @GN_ActivityID int = (SELECT Activity_ID FROM Mst_Activity WHERE ActivityType = 'GroupNote'); 	--- 	DECLARE @DirectBillReferral INT = (SELECT EnumValue FROM Mst_Enum WHERE EnumType = 'TypeOfReferral' AND EnumName = 'DirectBillReferral'); 	DECLARE @CoCM INT = (SELECT EnumValue FROM Mst_Enum WHERE EnumType = 'TypeOfReferral' AND EnumName = 'DirectCoCMReferral'); 	DECLARE @SelfPay INT = (SELECT EnumValue FROM Mst_Enum WHERE EnumType = 'TypeOfReferral' AND EnumName = 'Self-Pay'); 	DECLARE @MAT INT = (SELECT EnumValue FROM Mst_Enum WHERE EnumType = 'TypeOfReferral' AND EnumName = 'MATReferral'); 	 	DECLARE patientStatusUpdateCursor CURSOR FOR 	SELECT P.Patient_ID,TPA.Patient_Activity_ID,P.TypeOfReferral,--E.Discription, 	Coalesce(TPA.Activity_Actual_End_Time, TPA.Activity_Actual_Start_Time,TPA.Activity_Start_Date) ActivityDate 	FROM Mst_Patient P 	INNER JOIN Trn_Patient_Activity TPA ON P.Patient_ID = TPA.Patient_ID AND TPA.Activity_ID IN (@IA_ActivityID,@PN_ActivityID,@GN_ActivityID) 	INNER JOIN Mst_Enum E ON P.TypeOfReferral = E.EnumValue AND E.EnumType = 'TypeOfReferral' 	WHERE P.PatientStatusId != @InactivePatientStatusID AND Patient_Activity_ID IN ( 	    SELECT MAX(Patient_Activity_ID) 	    FROM Trn_Patient_Activity 		WHERE Activity_ID IN (@IA_ActivityID,@PN_ActivityID,@GN_ActivityID) 	    GROUP BY Patient_ID 	) AND P.Account_ID = @AccountID 	ORDER BY P.Patient_ID 	 	OPEN patientStatusUpdateCursor 	FETCH NEXT FROM patientStatusUpdateCursor 	INTO @Patient_ID,@Patient_Activity_ID,@TypeOfReferral,@ActivityDate 	WHILE @@FETCH_STATUS = 0 	BEGIN 		DECLARE @DateDifference int = (SELECT DATEDIFF(day, @ActivityDate, GETDATE())); 		--If Referral Type = CoCM, Direct Care or Self-Pay from Referral Info tab  		--AND patient has not attended an IA, PN, GN in the last 90 days, then set Patient Status to "Inactive" 		IF(@TypeOfReferral IN (@DirectBillReferral,@CoCM,@SelfPay) AND @DateDifference >= 90) 		BEGIN 			DECLARE @TypeReferralName varchar(250) = (SELECT Discription FROM Mst_Enum WHERE EnumType = 'TypeOfReferral' AND EnumValue = @TypeOfReferral); 			UPDATE Mst_Patient SET PatientStatusId = @InactivePatientStatusID,PatientStatusDate = GETDATE() 			WHERE Patient_ID = @Patient_ID 			-- Maintain Log 			--'Auto Inserted. While match condtion Referral type is '+@TypeReferralName+' and Date difference is '+@DateDifference+' .Hence status is set to Inactive' 			--INSERT INTO TrnPatientStatusLog(PatientID,PatientStatusId,PatientStatusDate,PatientStatusOtherText,CreatedBy,CreatedOn) 			--VALUES(@Patient_ID,@InactivePatientStatusID,GETDATE(),'Auto Inserted' ,1,GETDATE()) 		END 		--If Referral Type = MAT  from Referral Info tab  		--AND patient has not attended an IA, PN, GN in the last 45 days, then set Patient Status to "Inactive" 		IF(@TypeOfReferral = @MAT AND @DateDifference >= 45) 		BEGIN 			UPDATE Mst_Patient SET PatientStatusId = @InactivePatientStatusID,PatientStatusDate = GETDATE() 			WHERE Patient_ID = @Patient_ID 			-- Maintain Log 			--'Auto Inserted. While match condtion Referral type is MAT and Date difference is '+@DateDifference+' .Hence status is set to Inactive' 			--INSERT INTO TrnPatientStatusLog(PatientID,PatientStatusId,PatientStatusDate,PatientStatusOtherText,CreatedBy,CreatedOn) 			--VALUES(@Patient_ID,@InactivePatientStatusID,GETDATE(),'Auto Inserted' ,1,GETDATE()) 		END 	FETCH NEXT FROM patientStatusUpdateCursor 	INTO @Patient_ID,@Patient_Activity_ID,@TypeOfReferral,@ActivityDate END CLOSE patientStatusUpdateCursor; DEALLOCATE patientStatusUpdateCursor; END --EXEC USP_PatientStatusUpdateCursor 31