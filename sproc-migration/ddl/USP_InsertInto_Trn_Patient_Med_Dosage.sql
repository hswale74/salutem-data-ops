 Create procedure USP_InsertInto_Trn_Patient_Med_Dosage ( 	@Prescriber_ID INT, 	@Patient_ID INT, 	@Med_ID INT, 	@Med_Strength_ID INT, 	@DaysSupply INT, 	@ServiceDate DateTime, 	@Patient_Dosage_Qty Decimal(18,2), 	@Refill_Next_Date DateTime, 	@RxNumber VARCHAR(50), 	@DawCode NVARCHAR(100), 	@PartDDrugIndicator NVARCHAR(100), 	@MemberCopayment NVARCHAR(100), 	@ClientCost NVARCHAR(100), 	@RxClaimNumber NVARCHAR(100), 	@SequenceNumber NVARCHAR(100), 	@PharmacyNPI VARCHAR(50), 	@UserId INT ) AS BEGIN 	Declare @Patient_Dosage_ID INT = 0; 	Declare @Today DateTime = GetDate(); 	SET NOCOUNT ON  	INSERT INTO Trn_Patient_Med_Dosage (Prescriber_ID,Patient_Dosage_PrescribedOn,Patient_Dosage_Prescribed_Status,Patient_Dosage_Qty, 	Patient_Dosage_Status,Patient_Dosage_CreatedOn,Patient_Dosage_CreatedBy,Patient_ID,Med_ID,Med_Strength_ID,Refill_Prev_Date,Refill_Next_Date,RxNumber,ServiceDate,DawCode,PartDDrugIndicator, 	DaysSupply,MemberCopayment,ClientCost,RxClaimNumber,SequenceNumber,PharmacyNPI)  	VALUES (@Prescriber_ID,@ServiceDate,1,@Patient_Dosage_Qty,1,@Today,@UserId,@Patient_ID,@Med_ID,@Med_Strength_ID,@ServiceDate,@Refill_Next_Date,@RxNumber, 	@ServiceDate,@DawCode,@PartDDrugIndicator,@DaysSupply,@MemberCopayment,@ClientCost,@RxClaimNumber,@SequenceNumber,@PharmacyNPI)  	SET @Patient_Dosage_ID = SCOPE_IDENTITY()  	--Updating Medicine status as completed for past medicines whose status is active and Refill next date is past 	UPDATE Trn_Patient_Med_Dosage SET Patient_Dosage_Prescribed_Status = 3, --This needs to be map with Enum DosagePrescribedStatus of value Completed 		Patient_Dosage_UpdatedBy = @UserId, 		Patient_Dosage_UpdatedOn = @Today 	WHERE Patient_ID = @Patient_ID  		AND (Patient_Dosage_Prescribed_Status = 1 OR Patient_Dosage_Prescribed_Status IS NULL) 		AND Med_ID = @Med_ID AND ISNULL(Med_Strength_ID, 0 ) = @Med_Strength_ID AND ServiceDate < @ServiceDate AND Refill_Next_Date < @Today;  	--Updating Patient's Refill Next Date in Mst_Patient table. 	--It should be next minimum date from active medicine and whose Next Refill date in future. 	--Update Mst_Patient SET ReFillDueDate = (Select Min(Refill_Next_Date) Refill_Next_Date  	--	From Trn_Patient_Med_Dosage WHERE Patient_ID = @Patient_ID AND Refill_Next_Date > GETDATE() 	-- ) FROM Mst_Patient WHERE Patient_ID= @Patient_ID  	 SELECT @Patient_Dosage_ID END