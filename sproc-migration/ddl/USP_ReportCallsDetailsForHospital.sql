 CREATE procedure [dbo].[USP_ReportCallsDetailsForHospital] ( 	@AccountId INT, 	@activityId int, 	@fromDate DATETIME, 	@toDate DATETIME, 	@CallStatusID INT, 	@PCC INT, 	@orderBy nvarchar(50) = 'PatientFullName',  	@orderDir varchar(4) = 'asc',  	@StartFrom int = 0,  	@PageSize int = 999999999 ) AS BEGIN SET NOCOUNT ON; 	DECLARE @toDateUpEndOfTheDay DATETIME 	SELECT @toDateUpEndOfTheDay = DATEADD(DAY, 1, @toDate) 	 	BEGIN	 		With CallDetailsResult AS	(SELECT  				P.Patient_ID, Patient_MRN 				,Patient_First_Name +' '+ Patient_Last_Name AS PatientFullName 				,P.ZipCode, 				I.FinNumber,  				I.DRG,  				I.UnitNumber 				,I.DischargeDate 				,U.User_First_Name +' '+ U.User_Last_Name AS PCCName 				,CASE WHEN PA.Activity_Type_ID = 1 AND MA.ActivityType = 'HomeVisit' THEN '' ELSE  C.CallOutcome END AS CallStatusName -- When Activity_Type_ID is 1 means it is in-person activity so no need to show calloutcome from master table. 				,A.AttemptDate AS CallDate 				,PA.ActivityReasonDescription 		        ,PA.Activity_ID 				,PA.ActivityOutcomeName 				,PA.SpentTimeInMinutes 				FROM Mst_Patient P INNER JOIN Trn_InPatientLog I ON P.Patient_ID = I.Patient_ID 				INNER JOIN Trn_Patient_Activity PA ON PA.Patient_ID = I.Patient_ID AND I.InPatientLogId = PA.InPatientLogId 				INNER JOIN Mst_User U ON PA.Activity_Assigned_To = U.User_ID 				INNER JOIN  Trn_Activity_Attempt A ON PA.Patient_Activity_ID = A.Patient_Activity_ID 				INNER JOIN Mst_CallOutcome C ON C.Id= A.AttemptStatus 				INNER JOIN Mst_Activity MA ON MA.Activity_ID = PA.Activity_ID 			WHERE A.AttemptDate >= @fromDate AND A.AttemptDate <= @toDateUpEndOfTheDay 				AND (@CallStatusID = 0 OR A.AttemptStatus = @CallStatusID)  				AND PA.Activity_ID = @ActivityId				 				AND (@PCC = 0 OR PA.Activity_Assigned_To = @PCC)			 			),  				OrderByResult AS (SELECT *, 				ROW_NUMBER() over ( 				order BY case when @orderBy = 'Patient_MRN' and @orderDir = 'asc' then Patient_MRN end, 									case when @orderBy = 'Patient_MRN' and @orderDir = 'desc' then Patient_MRN end desc, 									case when @orderBy = 'PatientFullName' and @orderDir = 'asc' then PatientFullName end, 									case when @orderBy = 'PatientFullName' and @orderDir = 'desc' then PatientFullName end desc, 									case when @orderBy = 'AttemptDate' and @orderDir = 'asc' then CallDate end, 									case when @orderBy = 'AttemptDate' and @orderDir = 'desc' then CallDate end desc  				) AS RowNumber FROM CallDetailsResult  		)   		SELECT *, (Select Count(Patient_ID) FROM CallDetailsResult) TotalRows   		FROM OrderByResult  		WHERE OrderByResult.RowNumber BETWEEN (@StartFrom + 1) AND (@StartFrom  + @pageSize) 		 	END  END  --Exec USP_ReportCallsDetailsForHospital 21, 3, '01Nov2022','15Nov2022',0,0