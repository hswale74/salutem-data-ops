 CREATE procedure USP_GetBRReport ( 	@AccountID INT, 	@fromDate DATETIME, 	@orderBy nvarchar(50) = 'PatientFullName',  	@orderDir varchar(4) = 'asc', 	@Search NVARCHAR(MAX) = '', 	@StartFrom int = 0,  	@PageSize int = 999999999 ) AS BEGIN 	SET NOCOUNT ON 	DECLARE @GenericNoteActivityID int =(SELECT Activity_ID FROM Mst_Activity WHERE ActivityType = 'GenericNote'); 	DECLARE @GenericNoteType int = (SELECT ID FROM Mst_Enum WHERE EnumType = 'GenericNoteType' AND EnumName = 'DocumentUpload'); 	DECLARE @GenericNoteTypePsyConsultReview int = (SELECT ID FROM Mst_Enum WHERE EnumType = 'GenericNoteType' AND EnumName = 'PsychiatricConsultantReview'); 	DECLARE @OpenCaseActivityID int =(SELECT Activity_ID FROM Mst_Activity WHERE ActivityType = 'OpenCase') 	DECLARE @PsychConsultActivityID int =(SELECT Activity_ID FROM Mst_Activity WHERE ActivityType = 'PsychConsult') 	--DECLARE @AccountID int= 22;  	CREATE TABLE #BillingActivityIDs( 		ActivityID int, 		ActivityType varchar(250) 	) 	-- Getting billing activity ID's 	INSERT INTO #BillingActivityIDs SELECT Activity_ID,ActivityType FROM Mst_Activity WHERE ActivityType IN ('InitialAssessment','ProgressNote','GroupNote','ClinicalCareScreening')  	CREATE TABLE #BillingActivityies( 		Patient_ID int, 		Patient_Activity_ID int, 		Activity_Assigned_To int, 		ActivityType varchar(250) 	); -- 	INSERT INTO #BillingActivityies  	SELECT TPA.Patient_ID,TPA.Patient_Activity_ID,TPA.Activity_Assigned_To, BA.ActivityType 	FROM Trn_Patient_Activity TPA  	INNER JOIN #BillingActivityIDs BA ON TPA.Activity_ID = BA.ActivityID 	WHERE MONTH(TPA.DateOfService) = MONTH(@fromDate) AND YEAR(TPA.DateOfService) = YEAR(@fromDate) 	AND TPA.IsSubmited = 1 AND TPA.IsBillable = 1 AND TPA.Activity_Status = 1  	CREATE TABLE #BRReportActivityList( 	PatientActivityID int, 	PatientID int, 	AssociatedPatientActivityID int, 	NoteType int, 	ActivityCount int );  	--Getting billing activities thoes are having generic note activity associated more than once 	-- OR generic note activity not associated 	-- (Make sure generic note type should be document uploaded) 	INSERT INTO #BRReportActivityList  	SELECT BA.Patient_Activity_ID,BA.Patient_ID, PAL.AssociatedPatientActivityID, PAL.NoteType, 		COUNT(BA.Patient_Activity_ID) ActivityCount 	FROM #BillingActivityies BA 	LEFT JOIN TrnPatientAssessmentLog PAL ON BA.Patient_Activity_ID = PAL.AssociatedPatientActivityID 	LEFT JOIN Trn_Patient_Activity TPA ON PAL.PatientActivityID = TPA.Patient_Activity_ID  WHERE (PAL.NoteType = @GenericNoteType OR PAL.NoteType IS NULL) AND (TPA.Activity_Status =1 OR TPA.Activity_Status IS NULL) GROUP BY BA.Patient_Activity_ID,BA.Patient_ID, PAL.AssociatedPatientActivityID, PAL.NoteType HAVING COUNT(BA.Patient_Activity_ID) > 1 OR PAL.AssociatedPatientActivityID  IS NULL  	INSERT INTO #BRReportActivityList 	SELECT BA.Patient_Activity_ID,BA.Patient_ID, PAL.AssociatedPatientActivityID, PAL.NoteType, 		COUNT(BA.Patient_Activity_ID) ActivityCount 	FROM #BillingActivityies BA 	LEFT JOIN TrnPatientAssessmentLog PAL ON BA.Patient_Activity_ID = PAL.AssociatedPatientActivityID  	AND PAL.NoteType = @GenericNoteTypePsyConsultReview 	LEFT JOIN Trn_Patient_Activity TPA ON PAL.PatientActivityID = TPA.Patient_Activity_ID  WHERE BA.ActivityType = 'InitialAssessment' AND (TPA.Activity_Status =1 OR TPA.Activity_Status IS NULL) GROUP BY BA.Patient_Activity_ID,BA.Patient_ID, PAL.AssociatedPatientActivityID, PAL.NoteType HAVING COUNT(BA.Patient_Activity_ID) > 1 OR PAL.AssociatedPatientActivityID  IS NULL   -----------------------START OF OPEN AND PSYCH COUNT QUERY BLOCK--------------------------------------------------------------------------------------------------------------------- 	CREATE TABLE #OpenCasePatient( PatientID int )  	INSERT INTO #OpenCasePatient SELECT DISTINCT P.Patient_ID FROM Mst_Patient P  INNER JOIN Trn_Patient_Activity TPA ON P.Patient_ID = TPA.Patient_ID AND p.Account_ID = @AccountID AND Patient_Status =1 WHERE Activity_ID IN (@OpenCaseActivityID,@PsychConsultActivityID)  AND MONTH(TPA.DateOfService) = MONTH(@fromDate) AND YEAR(TPA.DateOfService) = YEAR(@fromDate) AND IsSubmited =1 AND Activity_Status = 1 GROUP BY P.Patient_ID;  	CREATE Table #tblOpenCaseCount 	( 		PatientID int, 		OpenCaseCount int 	)  	CREATE Table #tblPsychConsultCount ( 	PatientID int, 	PsychConsultCount int )   	INSERT INTO #tblOpenCaseCount SELECT P.PatientID,Count(Patient_Activity_ID) OpenCaseCount FROM #OpenCasePatient P  INNER JOIN Trn_Patient_Activity TPA ON P.PatientID = TPA.Patient_ID  WHERE Activity_ID IN (@OpenCaseActivityID)  GROUP BY P.PatientID  	INSERT INTO #tblPsychConsultCount SELECT P.PatientID,Count(Patient_Activity_ID) PsychConsultCount FROM #OpenCasePatient P  INNER JOIN Trn_Patient_Activity TPA ON P.PatientID = TPA.Patient_ID  WHERE Activity_ID IN (@PsychConsultActivityID)  GROUP BY P.PatientID  	INSERT INTO #BRReportActivityList(PatientID)  	SELECT o.PatientID FROM #OpenCasePatient O 	LEFT JOIN #tblOpenCaseCount A ON O.PatientID =A.PatientID 	LEFT JOIN #tblPsychConsultCount B ON O.PatientID =B.PatientID 	WHERE Coalesce(A.OpenCaseCount,0) != Coalesce(B.PsychConsultCount,0)   	DROP TABLE #OpenCasePatient 	DROP TABLE #tblOpenCaseCount 	DROP TABLE #tblPsychConsultCount ---------------------------END OF OPEN AND PSYCH COUNT QUERY BLOCK-----------------------------------------------------------------------------------------------------  	CREATE TABLE #PatientDetails( 		PatientID int, 		PatientMRN nvarchar(250), 		PatientFullName nvarchar(500), 		PatientDOB date, 		PatientPracticeName nvarchar(500), 		PatientStatusName nvarchar(500), 		PatientActivityID int, 		ActivityName nvarchar(500), 		AssignToName nvarchar(500), 		DateOfService date 	);  	INSERT INTO #PatientDetails 	SELECT P.Patient_ID,P.Patient_MRN,P.Patient_First_Name + ' '+P.Patient_Last_Name PatientFullName 		,P.Patient_DOB, PR.PracticeName,PS.StatusName, AL.PatientActivityID 		,A.Activity_Name,U.User_First_Name +' ' + U.User_Last_Name AssignToName,TPA.DateOfService 	FROM #BRReportActivityList AL 	INNER JOIN Mst_Patient P ON AL.PatientID = P.Patient_ID 	LEFT JOIN Mst_Practice PR ON P.PatientPracticeId = PR.ID 	LEFT JOIN MstPatientStatuses PS ON P.PatientStatusId = PS.ID 	LEFT JOIN Trn_Patient_Activity TPA ON AL.PatientActivityID = TPA.Patient_Activity_ID 	LEFT JOIN Mst_Activity A ON TPA.Activity_ID = A.Activity_ID 	LEFT JOIN Mst_User U ON TPA.Activity_Assigned_To = U.User_ID  	SELECT PatientID,PatientMRN,PatientFullName,PatientDOB,PatientPracticeName,PatientStatusName 			,PatientActivityID,ActivityName,AssignToName,DateOfService 	FROM #PatientDetails  	DROP TABLE #BillingActivityIDs 	DROP TABLE #BillingActivityies 	DROP TABLE #BRReportActivityList 	DROP TABLE #PatientDetails END  --EXEC USP_GetBRReport 22,'01/01/2023'