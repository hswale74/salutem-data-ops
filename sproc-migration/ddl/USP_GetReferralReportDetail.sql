 Create procedure [DBO].USP_GetReferralReportDetail ( 	@AccountId INT, 	@FromDate Datetime, 	@ToDate Datetime, 	@search nvarchar(50) = '',  	@orderBy nvarchar(50) = 'PatientName',  	@orderDir varchar(4) = 'asc',  	@StartFrom int = 0,  	@PageSize int = 999999999 ) AS BEGIN    -- getting previous patient stauts from log table 	;WITH MyCte AS      (         SELECT PatientID,PatientStatusId,PatientStatusDate,          ROW_NUMBER() OVER (PARTITION BY PatientID Order by ID DESC) AS RowNum         FROM TrnPatientStatusLog     )     SELECT PatientID, PatientStatusId,PatientStatusDate 	into #temp1        FROM    MyCte     WHERE   RowNum = 2  	SET @ToDate = DATEADD(Day,1,@ToDate); 	SET NOCOUNT ON; 	 With ReferralResult AS ( 		SELECT 			P.Patient_ID,     			P.Patient_MRN, 			P.Patient_First_Name+' '+P.Patient_Last_Name PatientName, 			P.ReferralDate, 			PHY.PhysicianName ReferringProvider, 			PR.PracticeName, 			DATEADD(HOUR,-5,P.Patient_CreatedAt) PatientCreatedOn, 			PS.StatusName PatientCurrentStatus, 			DATEADD(HOUR,-5,P.PatientStatusDate) PatientCurrentDate 			,TPS.StatusName PatientStatus 			,DATEADD(HOUR,-5,TS.PatientStatusDate) PatientStatusDate 		FROM Mst_Patient P 		LEFT JOIN Mst_Practice PR ON P.PatientPracticeId = PR.ID     		LEFT JOIN MstPatientStatuses PS ON P.PatientStatusId = PS.StatusID 		LEFT JOIN Mst_Physician PHY ON P.ReferringProviderId = PHY.ID 		LEFT JOIN #temp1 TS ON P.Patient_ID = TS.PatientID 		LEFT JOIN MstPatientStatuses TPS ON TS.PatientStatusId = TPS.StatusID 		WHERE  		Account_ID = @AccountId  		AND P.Patient_Status = 1 		AND P.Patient_CreatedAt >=  @FromDate 		AND P.Patient_CreatedAt <  @ToDate 		AND P.ReferralDate IS NOT NULL 		GROUP BY P.Patient_ID,TS.PatientStatusDate,Patient_MRN, 		Patient_First_Name,Patient_Last_Name,ReferralDate,PR.PracticeName,PHY.PhysicianName,PS.StatusName, 		P.PatientStatusDate,TPS.StatusName,P.Patient_CreatedAt 	),  	OrderByResult AS (SELECT *, 			ROW_NUMBER() over ( 			order BY case when @orderBy = 'PatientName' and @orderDir = 'asc' then PatientName end, 								case when @orderBy = 'PatientName' and @orderDir = 'desc' then PatientName end desc, 								case when @orderBy = 'ReferralDate' and @orderDir = 'asc' then ReferralDate end, 								case when @orderBy = 'ReferralDate' and @orderDir = 'desc' then ReferralDate end desc, 								case when @orderBy = 'ReferringProvider' and @orderDir = 'asc' then ReferringProvider end, 								case when @orderBy = 'ReferringProvider' and @orderDir = 'desc' then ReferringProvider end desc, 								case when @orderBy = 'PracticeName' and @orderDir = 'asc' then PracticeName end, 								case when @orderBy = 'PracticeName' and @orderDir = 'desc' then PracticeName end desc, 								case when @orderBy = 'PatientCurrentStatus' and @orderDir = 'asc' then PatientCurrentStatus end, 								case when @orderBy = 'PatientCurrentStatus' and @orderDir = 'desc' then PatientCurrentStatus end desc, 								case when @orderBy = 'PatientCurrentDate' and @orderDir = 'asc' then PatientCurrentDate end, 								case when @orderBy = 'PatientCurrentDate' and @orderDir = 'desc' then PatientCurrentDate end desc 								 			) AS RowNumber FROM ReferralResult  	) 	 	SELECT *, (Select Count(Patient_ID) FROM ReferralResult) TotalRows   	FROM OrderByResult  	WHERE OrderByResult.RowNumber BETWEEN (@StartFrom + 1) AND (@StartFrom  + @pageSize) 		 	Drop table #temp1 END  --EXEC USP_GetReferralReportDetail 31,'01/01/2023','07/26/2023','' --exec [dbo].[USP_GetReferralReportDetail] @AccountId=22,@FromDate='2023-01-01 00:00:00',@ToDate='2023-07-14 00:00:00',@search=N'',@orderBy=N'Patient_MRN',@orderDir='asc',@StartFrom=0,@PageSize=10