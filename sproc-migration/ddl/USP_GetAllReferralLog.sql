 Create procedure [dbo].[USP_GetAllReferralLog] ( 	@userId int, 	@search nvarchar(50) = '',  	@orderBy nvarchar(50) = 'Referral_ID',  	@orderDir varchar(4) = 'asc',  	@pageIndex int = 0,  	@pageSize int = 99999 ) AS BEGIN 	SET NOCOUNT ON; 	Declare @isAdmin BIT; 	SET @isAdmin = dbo.func_IsUserAdmin(@userId);  	WITH Result AS ( 		SELECT RPL.Referral_ID, 				RPL.Patient_ID, 				enum.Discription AS IncomingType, 				RPL.ReferralDate,  				RPL.ReferralTime, 				PRAC.PracticeName, 				RPL.AssignTo, 				usr.User_First_Name + ' ' + usr.User_Last_Name AS AssignUserName, 				RPL.ReferralStatus, 				enums.Discription AS ReferralStatusName, 				RPL.FileName, 				RPL.LongFileName 		FROM ReferralPatientLog RPL 		INNER JOIN Mst_Enum enum ON RPL.ReferralType = enum.EnumValue AND EnumType = 'ReferralIncomingType' 		LEFT JOIN Mst_Practice PRAC ON RPL.PatientPractice = PRAC.ID 		LEFT JOIN Mst_User usr ON RPL.AssignTo = usr.User_ID 		LEFT JOIN Mst_Enum enums ON RPL.ReferralStatus = enums.EnumValue AND enums.EnumType = 'ReferralStatus' 		WHERE RPL.IsPatientRegistered = 0 			AND ( (RPL.PatientFirstName + ' ' + RPL.PatientLastName)  LIKE '%' + @search + '%' 			OR RPL.FaxNumber LIKE '%' + @search + '%' 			OR RPL.PrimaryContactNumber LIKE '%' + @search + '%' 			OR RPL.PrimaryContactEmail LIKE '%' + @search + '%' 			OR @search = '')  			AND (@isAdmin = 1 OR RPL.AssignTo = @userId OR RPL.AssignTo IS NULL)   	),  	OrderByResult AS (SELECT *, 			ROW_NUMBER() over ( 			order BY case when @orderBy = 'IncomingType' and @orderDir = 'asc' then IncomingType end, 								case when @orderBy = 'IncomingType' and @orderDir = 'desc' then IncomingType end desc, 								case when @orderBy = 'PracticeName' and @orderDir = 'asc' then PracticeName end, 								case when @orderBy = 'PracticeName' and @orderDir = 'desc' then PracticeName end desc 								 			) AS RowNumber FROM Result  	)   	SELECT *, (Select Count(Patient_ID) FROM Result) TotalRows   	FROM OrderByResult  	WHERE OrderByResult.RowNumber BETWEEN (@pageIndex + 1) AND (@pageIndex  + @pageSize) END