--EXEC USP_GetAllPatientOutreachList 31,0,0,null,null,null,'' CREATE procedure USP_GetAllPatientOutreachList  ( 	@AccountId INT, 	@PracticeID INT=0, 	@PatientStatus INT=0, 	@LastCallOutcomeName varchar(500)=null, 	@FromDate Datetime=null, 	@ToDate Datetime=null, 	@search nvarchar(50) = '',  	@orderBy nvarchar(50) = 'DisplayReferralDate',  	@orderDir varchar(4) = 'desc',  	@StartFrom int = 0,   	@pageSize int = 99999 ) AS BEGIN 	DECLARE @toDateUpEndOfTheDay DATETIME; 	IF @ToDate IS NOT NULL 	BEGIN 		SELECT @toDateUpEndOfTheDay = DATEADD(DAY, 1, @ToDate); 	END 	DECLARE @CallCount int; 	 WITH Result AS ( 	SELECT   		P.Patient_ID, 		P.Patient_First_Name + ' ' + P.Patient_Last_Name AS PatientFullName, 	    P.Patient_MRN, 		P.Patient_DOB, 		P.Patient_Gender, 		P.ReferralDate, 		P.ReferringProviderId,		 		P.TypeOfReferral, 		fp.LastCallDate, 		fp.LastCallOutcomeName, 		fp.LastOutreachby, 		P.AttemptCount as AttemptCount, 		P.Mobile, 		P.PatientStatusId, 		MPS.StatusName AS DispalyPatientStatus, 		ME.Discription AS DisplayTypeOfReferral, 		Ph.PhysicianName AS ReferringProviderName, 		MP.PracticeName 	FROM Mst_Patient P 	 	INNER JOIN MstPatientStatuses MPS ON MPS.StatusID = P.PatientStatusId 	INNER JOIN Mst_Physician Ph ON P.ReferringProviderId = Ph.ID 	INNER JOIN Mst_Enum ME ON ME.EnumValue = P.TypeOfReferral AND ME.EnumType='TypeOfReferral' 	OUTER apply dbo.funcGetPatientCommunicationDetails(P.Patient_ID,'Call') fp 	LEFT JOIN Mst_Practice MP ON P.PatientPracticeId = MP.ID 	WHERE P.Account_ID = @AccountId   	AND  MPS.StatusName IN ('Attempting to Enroll','New Referral','Intake Pending','Reschedule intake','Check Contact Information') 	AND(@fromDate IS NULL OR P.ReferralDate >= @fromDate) 	AND (@ToDate IS NULL OR P.ReferralDate < @toDateUpEndOfTheDay) 	AND  ((P.Patient_First_Name + ' ' + P.Patient_Last_Name) LIKE '%' + @search + '%' 			OR (P.Patient_Last_Name + ' ' + P.Patient_First_Name) LIKE '%' + @search + '%' 			OR P.Patient_MRN LIKE '%' + @search + '%' 			OR P.Mobile LIKE '%' + @search + '%') 	AND (@PracticeID = 0 OR P.PatientPracticeId = @PracticeID) 	AND (@PatientStatus = 0 OR P.PatientStatusId = @PatientStatus) 	AND (@LastCallOutcomeName IS NULL OR fp.LastCallOutcomeName LIKE '%'+ @LastCallOutcomeName +'%') 			),  	OrderByResult AS (SELECT *, 			ROW_NUMBER() over ( 			order BY case when @orderBy = 'DisplayReferralDate' and @orderDir = 'asc' then ReferralDate end, 								case when @orderBy = 'DisplayReferralDate' and @orderDir = 'desc' then ReferralDate end desc, 								case when @orderBy = 'PracticeName' and @orderDir = 'asc' then PracticeName end, 								case when @orderBy = 'PracticeName' and @orderDir = 'desc' then PracticeName end desc 			 	 			) AS RowNumber FROM Result  	) 	 	SELECT *, (Select Count(Patient_ID) FROM Result) TotalRows   	FROM OrderByResult  	WHERE  OrderByResult.RowNumber BETWEEN (@StartFrom + 1) AND (@StartFrom  + @pageSize) 	 	 END  --exec [dbo].[USP_GetAllPatientOutreachList] @AccountId=22,@search=N'',@orderBy=N'DisplayReferralDate',@orderDir='desc',@StartFrom=0,@pageSize=10
