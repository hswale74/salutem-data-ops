 CREATE procedure USP_UpdatePatientRegistrySessionSummary ( 	@PatientID INT, 	@PatientActivityId INT, 	@MonthOfService DATE, 	@PracticeId INT, 	@PracticeBillingType INT, 	@MindHealthyFee DECIMAL ) AS BEGIN 	SET NOCOUNT ON;   	DECLARE	@LastMonthYearSeen DATETIME; 	DECLARE @MinutesOfThisMonth INT; 	DECLARE @RecentAttendanceName VARCHAR(250); 	DECLARE @BillableCPTCodes VARCHAR(250); 	DECLARE @CPTCode VARCHAR(50); 	DECLARE @AddOnCPTCode VARCHAR(50); 	DECLARE @SecondAddOnCPTCode VARCHAR(50);  	DECLARE @ActivityType VARCHAR(250); 	SELECT @ActivityType = MA.ActivityType FROM Trn_Patient_Activity PA INNER JOIN Mst_Activity MA ON PA.Activity_ID=MA.Activity_ID AND Patient_Activity_ID = @PatientActivityId;  	--Getting spent Minutes of current month billable session 	SELECT  @MinutesOfThisMonth = ISNULL(SUM(SpentDuration),0)  	FROM TrnPatientBillingDetail BD 	INNER JOIN TrnBillingProfile TBP ON TBP.PatientID = BD.PatientID AND TBP.PatientID = @PatientID 	AND TBP.MonthOfService = BD.MonthOfService 	AND BD.IsDeleted = 0 	AND BD.MonthOfService = @MonthOfService; 		 	SET @LastMonthYearSeen =  (SELECT top 1 MonthOfService FROM TrnBillingProfile WHERE PatientID = @PatientID AND MonthOfService < @MonthOfService ORDER BY MonthOfService DESC); 	 	SELECT @RecentAttendanceName = MAE.Discription FROM Mst_Patient P  	INNER JOIN MstAssessmentEnum MAE ON P.Attendance = MAE.EnumValue AND MAE.EnumType = 'Attendance';  	--SELECT @CPTCode = BillingCPTCode, @BillableCPTCodes = CONCAT_WS(', ',BillingCPTCode,AddOnCPTCode,SecondAddOnCode) FROM TrnBillingProfile WHERE PatientID = @PatientID AND MonthOfService = @MonthOfService; 	SELECT @CPTCode = BillingCPTCode, 		@AddOnCPTCode = AddOnCPTCode, 		@SecondAddOnCPTCode = SecondAddOnCode, 		@BillableCPTCodes = COALESCE(BillingCPTCode + ', ', '') + 			COALESCE(AddOnCPTCode + ', ', '') + 			COALESCE(SecondAddOnCode, '') 	FROM TrnBillingProfile 	WHERE PatientID = @PatientID AND MonthOfService = @MonthOfService;  	UPDATE TrnPatientRegistry  		SET PracticeId = @PracticeId,  		PracticeBillingType=@PracticeBillingType,  		MindHealthyFee = @MindHealthyFee, 		MinutesOfThisMonth = @MinutesOfThisMonth, 		LastMonthYearSeen = @LastMonthYearSeen, 		RecentAttendanceName = @RecentAttendanceName, 		BillableCPTCodes = @BillableCPTCodes, 		TotalSessionCount = ISNULL(TotalSessionCount, 0) + 1, 		MinutesToNextCode = (Select dbo.funcGetMinutestoNextCode(@CPTCode, @AddOnCPTCode, @SecondAddOnCPTCode, @MinutesOfThisMonth, @PatientID)) 	FROM TrnPatientRegistry R WHERE R.PatientID=@PatientID;  	IF @ActivityType = 'InitialAssessment' 	BEGIN  		UPDATE TrnPatientRegistry SET IALastDate = GETUTCDATE() FROM TrnPatientRegistry R WHERE R.PatientID=@PatientID; 	END 	ELSE IF @ActivityType = 'ProgressNote' 	BEGIN  		UPDATE TrnPatientRegistry SET PNLastDate = GETUTCDATE() FROM TrnPatientRegistry R WHERE R.PatientID=@PatientID; 	END 	ELSE IF @ActivityType = 'GroupNote' 	BEGIN  		UPDATE TrnPatientRegistry SET GNLastDate = GETUTCDATE() FROM TrnPatientRegistry R WHERE R.PatientID=@PatientID; 	END 	ELSE IF @ActivityType = 'ClinicalCareScreening' 	BEGIN  		UPDATE TrnPatientRegistry SET CCSLastDate = GETUTCDATE() FROM TrnPatientRegistry R WHERE R.PatientID=@PatientID; 	END  	SELECT ID,PatientID,TotalSessionCount,CCSLastDate,IALastDate,PNLastDate,GNLastDate,MindHealthyFee,MinutesOfThisMonth,BillableCPTCodes FROM TrnPatientRegistry WHERE PatientID = @PatientID; END -- EXEC USP_UpdatePatientRegistrySessionSummary 66604,5583,'2023-08-31', 1,1,12.00